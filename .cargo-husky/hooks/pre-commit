#!/bin/bash
#
# Forge pre-commit hook - mirrors CI checks
# Must be as strict as .github/workflows/ci.yml
# Auto-installed by cargo-husky on `cargo test`

set -e

echo "ğŸ” Running pre-commit checks..."

echo "ğŸ“ Checking formatting..."
cargo fmt --all -- --check

echo "ğŸ“ Running clippy (strict)..."
cargo clippy --all-targets --all-features -- -D warnings

echo "ğŸ§ª Running tests..."
cargo test --all-features

# RoyalBit Asimov checks (if installed)
if command -v asimov &> /dev/null; then
    # Protocol refresh - injects rules into fresh context (survives compaction)
    asimov refresh

    echo "ğŸ“‹ Validating protocol files..."
    asimov validate 2>/dev/null || true  # Don't fail on missing files

    echo "ğŸ“ Linting documentation..."
    asimov lint-docs docs/ || exit 1
fi

echo "âœ… Pre-commit checks passed!"
